// Prisma Schema for GalaCash
// Database: PostgreSQL
// Note: datasource URL is configured in prisma.config.ts (Prisma v7 best practice)

generator client {
  provider = "prisma-client"
  output   = "../src/prisma/generated"
}

datasource db {
  provider = "postgresql"
}

// ============ ENUMS ============

enum UserRole {
  user
  bendahara
}

enum TransactionType {
  income
  expense
}

enum TransactionCategory {
  kas_kelas
  donation
  fundraising
  office_supplies
  consumption
  event
  maintenance
  education
  health
  emergency
  equipment
  fine
  printing
  transport
  social
  other
  subscription
  competition
}

enum FundCategory {
  education
  health
  emergency
  equipment
  subscription
  consumption
  competition
  printing
  donation
  other
}

enum FundStatus {
  pending
  approved
  rejected
}

enum BillStatus {
  belum_dibayar
  menunggu_konfirmasi
  sudah_dibayar
}

enum PaymentMethod {
  bank
  ewallet
  cash
}

enum AccountType {
  bank
  ewallet
}

enum AccountStatus {
  active
  inactive
}

// ============ MODELS ============

model Class {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users            User[]
  transactions     Transaction[]
  fundApplications FundApplication[]
  cashBills        CashBill[]

  @@map("classes")
}

model User {
  id        String   @id @default(uuid())
  nim       String   @unique
  name      String
  email     String?  @unique
  password  String
  role      UserRole @default(user)
  avatarUrl String?
  classId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  class                    Class             @relation(fields: [classId], references: [id], onDelete: Cascade)
  refreshTokens            RefreshToken[]
  fundApplications         FundApplication[] @relation("Applicant")
  reviewedFundApplications FundApplication[] @relation("Reviewer")
  cashBills                CashBill[]        @relation("Student")
  confirmedCashBills       CashBill[]        @relation("Confirmer")

  @@index([classId])
  @@index([nim])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Transaction {
  id            String              @id @default(uuid())
  classId       String
  type          TransactionType
  category      TransactionCategory @default(other)
  description   String
  attachmentUrl String?
  amount        Decimal             @db.Decimal(12, 2)
  date          DateTime            @default(now())
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([date])
  @@index([type])
  @@index([category])
  @@map("transactions")
}

model FundApplication {
  id              String       @id @default(uuid())
  userId          String
  classId         String
  purpose         String
  description     String?
  category        FundCategory
  amount          Decimal      @db.Decimal(12, 2)
  status          FundStatus   @default(pending)
  attachmentUrl   String?
  rejectionReason String?
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  applicant Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  user      User  @relation("Applicant", fields: [userId], references: [id], onDelete: Cascade)
  reviewer  User? @relation("Reviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([classId])
  @@index([status])
  @@index([createdAt])
  @@map("fund_applications")
}

model CashBill {
  id               String         @id @default(uuid())
  userId           String
  classId          String
  billId           String         @unique
  month            Int // 1-12 for better queries and storage
  year             Int
  dueDate          DateTime
  kasKelas         Decimal        @db.Decimal(10, 2)
  biayaAdmin       Decimal        @db.Decimal(10, 2)
  totalAmount      Decimal        @db.Decimal(10, 2)
  status           BillStatus     @default(belum_dibayar)
  paymentMethod    PaymentMethod?
  paymentProofUrl  String?
  paymentAccountId String?
  paidAt           DateTime?
  confirmedBy      String?
  confirmedAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  user           User            @relation("Student", fields: [userId], references: [id], onDelete: Cascade)
  class          Class           @relation(fields: [classId], references: [id], onDelete: Cascade)
  confirmer      User?           @relation("Confirmer", fields: [confirmedBy], references: [id], onDelete: SetNull)
  paymentAccount PaymentAccount? @relation(fields: [paymentAccountId], references: [id], onDelete: SetNull)

  @@unique([userId, month, year])
  @@index([userId])
  @@index([classId])
  @@index([status])
  @@index([dueDate])
  @@index([paymentAccountId])
  // Composite indexes for common query patterns
  @@index([userId, status, dueDate])
  @@index([classId, status, dueDate])
  @@index([status, dueDate])
  @@index([month, year])
  @@map("cash_bills")
}

model PaymentAccount {
  id            String        @id @default(uuid())
  name          String // e.g., "BCA - Class Treasury"
  accountType   AccountType
  accountNumber String?
  accountHolder String?
  description   String?
  status        AccountStatus @default(active)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  cashBills CashBill[]

  @@index([status]) // For filtering active accounts
  @@map("payment_accounts")
}
